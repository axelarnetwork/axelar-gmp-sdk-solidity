name: "Aderyn Static Analysis"
description: "Run Aderyn static analysis and upload the report as an artifact"

inputs:
  rust_toolchain:
    description: "Rust toolchain version"
    required: true
    default: "stable"
  aderyn_version:
    description: "Aderyn version to install"
    required: true
    default: "v0.3.3"

runs:
  using: "composite"
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ inputs.rust_toolchain }}

    - name: Install Aderyn
      run: cargo install --git https://github.com/Cyfrin/aderyn.git --tag ${{ inputs.aderyn_version }}
      shell: bash

    - name: Generate Aderyn Report
      id: run_aderyn
      run: |
        aderyn --output report.md . 2>&1 | tee aderyn_output.log
        if grep -q "warning:" aderyn_output.log || grep -q "Found issues" aderyn_output.log; then
          echo "Aderyn analysis found warnings or issues."
          exit 1
        fi
      shell: bash

    - name: Upload Aderyn Report as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aderyn-report
        path: report.md